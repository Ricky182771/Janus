#!/usr/bin/env bash
# ──────────────────────────────────────────────────────────────────────────────
# Janus Project - Initialization Tool (janus-init) v0.1
# ──────────────────────────────────────────────────────────────────────────────
# Copyright (C) 2026 Ricardo (Ricky182771)
# Licensed under GNU GPL v3.0
#
# Description:
# Initializes the Janus environment.
# Creates directory structure, base configuration files and validates
# user permissions without performing destructive system changes.
#
# Usage:
#   ./janus-init [--help | --version]
# ──────────────────────────────────────────────────────────────────────────────

set -uo pipefail

VERSION="0.1"

# Paths
CONFIG_DIR="$HOME/.config/janus"
CACHE_DIR="$HOME/.cache/janus"
LOG_DIR="$CACHE_DIR/logs"
STATE_DIR="$CONFIG_DIR/state"
PROFILE_DIR="$CONFIG_DIR/profiles"

CONF_FILE="$CONFIG_DIR/janus.conf"
STATE_FILE="$STATE_DIR/janus.state"

# Colors
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
NC=$'\033[0m'

# Counters
WARN_COUNT=0
INFO_COUNT=0

log_info()  { printf "${BLUE}[INFO]${NC} %s\n" "$1"; ((INFO_COUNT++)); }
log_ok()    { printf "${GREEN}[OK]${NC} %s\n" "$1"; }
log_warn()  { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; ((WARN_COUNT++)); }
log_error() { printf "${RED}[ERROR]${NC} %s\n" "$1"; }

die() {
    log_error "$1"
    exit 1
}

show_help() {
local exit_code="${1:-0}"
cat <<EOF
Usage: ./janus-init [OPTIONS]

Options:
  --help, -h       Show this help
  --version, -v    Show version

Examples:
  ./janus-init
  ./janus-init --version

Notes:
  - This command is non-destructive and does not edit kernel/boot settings.
  - It only creates Janus state/config files in your home directory.
EOF
exit "$exit_code"
}

# ---------------------------
# Helpers
# ---------------------------

detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "${PRETTY_NAME:-$NAME}"
    else
        echo "Unknown"
    fi
}

check_group() {
    local group="$1"
    if groups | grep -qw "$group"; then
        log_ok "User belongs to '$group' group"
    else
        log_warn "User is NOT in '$group' group"
        log_info "Suggestion: sudo usermod -aG $group \$USER && re-login"
    fi
}

# ---------------------------
# Initialization steps
# ---------------------------

create_directories() {
    log_info "Creating Janus directory structure..."

    mkdir -p \
        "$CONFIG_DIR" \
        "$CACHE_DIR" \
        "$LOG_DIR" \
        "$STATE_DIR" \
        "$PROFILE_DIR" || die "Unable to create Janus directories under $HOME."

    log_ok "Directories initialized under ~/.config and ~/.cache"
}

create_config() {
    if [ -f "$CONF_FILE" ]; then
        log_ok "Configuration file already exists: janus.conf"
        return
    fi

    log_info "Generating base janus.conf"

    cat > "$CONF_FILE" <<EOF
# ─────────────────────────────────────────────
# Janus configuration file
# Generated by janus-init
# ─────────────────────────────────────────────

JANUS_VERSION="$VERSION"

# Host information
HOST_DISTRO="$(detect_distro)"
HOST_KERNEL="$(uname -r)"

# Core settings
VM_BACKEND="libvirt"
GPU_MODE="unset"
LOOKING_GLASS="disabled"

# Safety flags
INIT_COMPLETE="false"
EOF
    [ -f "$CONF_FILE" ] || die "Failed to create configuration file: $CONF_FILE"

    log_ok "janus.conf created"
}

create_state() {
    log_info "Writing Janus state file"

    cat > "$STATE_FILE" <<EOF
# Janus runtime state
INIT_DONE=true
INIT_DATE="$(date '+%Y-%m-%d %H:%M:%S')"
LAST_ACTION="janus-init"
EOF
    [ -f "$STATE_FILE" ] || die "Failed to create state file: $STATE_FILE"

    log_ok "State file written"
}

check_permissions() {
    log_info "Checking user permissions (non-destructive)"

    check_group "kvm"
    check_group "libvirt"

    if ! command -v systemctl >/dev/null 2>&1; then
        log_warn "systemctl not available; skipping libvirtd service check."
    elif systemctl is-active libvirtd >/dev/null 2>&1; then
        log_ok "libvirtd service is active"
    else
        log_warn "libvirtd service is not active"
        log_info "Suggestion: sudo systemctl enable --now libvirtd"
    fi
}

finalize_config() {
    log_info "Finalizing configuration flags"
    sed -i 's/INIT_COMPLETE="false"/INIT_COMPLETE="true"/' "$CONF_FILE" || die "Could not update INIT_COMPLETE in $CONF_FILE"
    log_ok "Janus marked as initialized"
}

summary() {
    echo "────────────────────────────────────────"
    printf "Initialization finished: %b%d%b WARN, %b%d%b INFO\n" \
        "${YELLOW}" "$WARN_COUNT" "${NC}" \
        "${BLUE}" "$INFO_COUNT" "${NC}"

    echo ""
    echo "Next steps:"
    echo "  → Review: $CONF_FILE"
    echo "  → Run: janus-check (if not already done)"
    echo "  → Continue with: janus-bind (when ready for VFIO)"
    echo ""
    echo "This command did not apply system-level changes."
}

# ---------------------------
# MAIN
# ---------------------------

main() {
    while [ $# -gt 0 ]; do
        case "$1" in
            --help|-h) show_help ;;
            --version|-v) echo "janus-init v$VERSION"; exit 0 ;;
            *) log_error "Unknown option: $1"; show_help 1 ;;
        esac
        shift
    done

    echo "=== Janus Initialization v$VERSION ==="
    create_directories
    create_config
    create_state
    check_permissions
    finalize_config
    summary
}

main "$@"
